<?!=HtmlService.createHtmlOutputFromFile('Stylesheet').getContent();?>

<!DOCTYPE html>
<html>
<head>

</head>
<body>

    <?!=HtmlService.createTemplateFromFile('Header').evaluate().getContent();?>

    <div class="container main-content">
        <div class="row">
            <?if(typeof data.kingdomHallAddress != 'undefined'){?>

            <div class="col-xs-4">
                <h3>Kingdom Hall Address:</h3>
            </div>
            <div class="col-xs-8">
                <h3>
                    <?=data.projectData.kingdomHallAddress?>

                </h3>
            </div>
            <?}?>

            <div class="col-xs-12">
                <div class="row">
                    <h3 class="col-xs-2">Core List</h3>
                    <div class="col-xs-10 form-inline" data-bind="visible: trades().length != 0">
                        <div class="form-group">
                            <label for="trades">Trade:</label>
                            <select class="form-control" data-bind="options: trades, value: selectedTrade, optionsCaption: 'Please Select...'"></select>
                        </div>
                        <div class="form-group" data-bind="visible: subCategories().length != 0">
                            <label for="trades">Category:</label>
                            <select class="form-control" data-bind="options: subCategories, value: selectedSubCategory, optionsCaption: 'Please Select...'"></select>
                        </div>
                        <div class="form-group" data-bind="visible: types().length != 0">
                            <label for="trades">Type:</label>
                            <select class="form-control" data-bind="options: types, value: selectedType, optionsCaption: 'Please Select...'"></select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <table class="table table-hover" id="itemPickerTableHeader">
                        <thead>
                            <tr>
                                <th>
                                    Item Code
                                </th>
                                <th>
                                    Item Description
                                </th>
                                <th>
                                    Part Number
                                </th>
                                <th>
                                    Project Dimension
                                </th>
                                <th style="text-align: right">
                                    Quantity Required
                                </th>
                                <th>&nbsp;</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="long-list-wrapper">
                        <table class="table table-hover">
                            <tbody data-bind="if: typeof items == 'undefined' || items == null || items().length == 0">
                            <tr class="info">
                                <td colspan="8">
                                    No Core List items have been loaded yet.
                                </td>
                            </tr>
                            </tbody>
                            <tbody data-bind="foreach: items, colWidthCalculate: items" id="itemPickerTableBody">
                                <tr data-bind="css: rowClass">
                                    <td data-bind="text: itemCode"></td>
                                    <td data-bind="text: itemDescription + (manufacturer.length > 0 ? ' [' + manufacturer + ']' : '') + (brand.length > 0 ? ' [' + brand + ']' : '')"></td>
                                    <td data-bind="text: partNumber"></td>
                                    <td>
                                        <select class="form-control" data-bind="options: pdcs, optionsValue: function(item){return item.code}, value: pdc, optionsText: function(item){ return item.code + ' ('  + item.description + ')'}, "></select>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control pull-right quantity" style="width: 45px;" data-bind="value: quantity" />
                                    </td>
                                    <td data-bind="text: purchaseUom + ' @ ' + factor + baseUom"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <h3>Saved Project Items</h3>
                    </div>
                </div>
                <div class="row">
                    <table class="table table-hover" id="basketTableHeader">
                        <thead>
                            <tr>
                                <th>
                                    Item Code
                                </th>
                                <th>
                                    Item Description
                                </th>                                
                                <th>
                                    Part Number
                                </th>
                                <th>
                                    Project Dimension
                                </th>
                                <th>
                                    Quantity Required
                                </th>
                                <th>&nbsp;</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="long-list-wrapper">
                        <table class="table table-hover" id="basketTableBody">
                            <tbody data-bind="if: typeof basketItems == 'undefined' || basketItems == null || basketItems().length == 0">
                                <tr class="info">
                                    <td colspan="8">
                                        No Core List items have been added to the basket yet.
                                    </td>
                                </tr>
                            </tbody>
                            <tbody data-bind="foreach: basketItems, colWidthCalculate: basketItems">
                                <tr data-bind="css: rowClass">
                                    <td data-bind="text: itemCode"></td>
                                    <td data-bind="text: itemDescription + (manufacturer.length > 0 ? ' [' + manufacturer + ']' : '') + (brand.length > 0 ? ' [' + brand + ']' : '')"></td>
                                    <td data-bind="text: partNumber"></td>
                                    <td data-bind="text: pdc"></td>
                                    <td data-bind="text: quantity"></td>
                                    <td data-bind="text: purchaseUom + ' @ ' + factor + baseUom"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<?!=HtmlService.createTemplateFromFile('JavaScript').evaluate().getContent();?>

<script language="javascript" type="text/javascript">
    var model;

    function loadSavedItems(savedItems) {
        for (var i = 0; i < model.allItems().length; i++) {
            var itemsSaved = $.grep(savedItems, function (el) {
                return el.itemCode === model.allItems()[i].itemCode;
            });

            if (itemsSaved.length > 0) {
                var savedItem = model.allItems()[i];
                savedItem.quantity = ko.observable(ko.utils.unwrapObservable(itemsSaved[0].quantity));
                savedItem.originalQuantity = ko.observable(ko.utils.unwrapObservable(itemsSaved[0].quantity));
                savedItem.pdc = ko.observable(ko.utils.unwrapObservable(itemsSaved[0].pdc));
                model.savedItems.push(savedItem);
            }
        }        
    }

    function filterItems(coreListData, trade, category, type)
    {
        var coreListDataParam = new jw.MaterialsTracker.Client.CoreListData(coreListData);

        var filterer = new jw.MaterialsTracker.Client.CoreListFilter(coreListDataParam);

        var filter = new jw.MaterialsTracker.Client.Filter();

        if (typeof trade != 'undefined')
        {
            filter.trade = trade;
        }

        if (typeof category != 'undefined')
        {
            filter.category = category;
        }

        if (typeof type != 'undefined')
        {
            filter.type = type;
        }

        var filteredData = filterer.filterCoreList(filter);

        model.items(filteredData.listData);

        model.subCategories(filteredData.subCategories);

        model.types(filteredData.types);
    }


    $(function ()
    {        

        $('table').on('blur', '.quantity', function(event)
        {
            var item = ko.dataFor(this);
            
            var itemCode = item.itemCode;

            var pdc = item.pdc;

            var basketItemsOfType = $.grep(model.basketItems(), function (el)
                {
                    return el.itemCode === itemCode;
                });

            if (basketItemsOfType.length > 0)
            {
                for (var i = 0; i < model.basketItems().length; i++)
                {
                    if (model.basketItems()[i].itemCode === itemCode && model.basketItems()[i].pdc === pdc)
                    {
                        model.basketItems()[i].quantity(ko.utils.unwrapObservable(item.quantity));

                        model.basketItems()[i].pdc(ko.utils.unwrapObservable(item.pdc));

                        var q = ko.utils.unwrapObservable(item.quantity);

                        //Removing an item from the basket
                        if (q === '' || ($.isNumeric(q) && parseInt(q) === 0))
                        {
                            if (model.basketItems()[i].isSaved())
                            {
                                //If it was saved then flag it as removed
                                model.basketItems()[i].isRemoved(true);
                            } else
                            {
                                //Otherwise just remove it from the basketItems observable
                                model.basketItems.remove(function(item)
                                {
                                    return item.itemCode === itemCode;
                                });

                                //Remove all flags from the original item
                                item.isSaved(false);
                                item.isAdded(false);
                                item.isRemoved(false);
                            }                                                                
                        } else if(q !== '' && ($.isNumeric(q) &&  parseInt(q) > 0))
                        {
                            //Changing an item in the basket, but not removing it
                            if (model.basketItems()[i].isSaved())
                            {
                                //If the quantity is different from that saved then flag it as isAdded (dirty)
                                if (parseInt(model.basketItems()[i].originalQuantity()) !== parseInt(q))
                                {
                                    model.basketItems()[i].isAdded(true);
                                } else
                                {
                                    model.basketItems()[i].isAdded(false);
                                    model.basketItems()[i].isRemoved(false);
                                }
                            }                                
                        }

                        break;
                    }
                }
            }
            else
            {
                item.quantity = ko.observable(ko.utils.unwrapObservable(item.quantity));

                item.pdc = ko.observable(ko.utils.unwrapObservable(item.pdc));

                if (item.quantity() !== '' && item.quantity() > 0)
                {
                    item.isAdded(true);
                }                    

                model.basketItems.push(item);
            }            
        });

        model = {
            items: ko.observableArray([]),
            allItems: ko.observableArray([]),
            selectedItems: ko.observableArray([]),
            trades: ko.observableArray([]),
            subCategories: ko.observableArray([]),
            types: ko.observableArray([]),
            projectDimensions: ko.observableArray([]),
            selectedTrade: ko.observable(''),
            selectedSubCategory: ko.observable(''),
            selectedType: ko.observable(''),
            selectedProjectDimension: ko.observable(),
            savedItems: ko.observableArray([]),
            basketItems: ko.observableArray([])
        };

        var trades = JSON.parse('<?=data.trades?>');

        model.trades(trades);

        var coreListData = JSON.parse('<?=data.coreListData?>');

        for (var i = 0; i < coreListData.length; i++)
        {
            coreListData[i].pdc = ko.observable(coreListData[i].pdc);
            coreListData[i].isSaved = ko.observable(coreListData[i].isSaved);
            coreListData[i].isAdded = ko.observable(false);
            coreListData[i].isRemoved = ko.observable(false);
            coreListData[i].rowClass = ko.computed(function ()
            {
                if (this.isAdded())
                {
                    return 'warning';
                }
                if (this.isRemoved())
                {
                    return 'danger';
                }
                if (this.isSaved())
                {
                    return 'success';
                }
            }, coreListData[i]);
        }

        model.allItems(coreListData);

        model.items(coreListData);

        var savedCoreListData = JSON.parse('<?=data.savedCoreListData?>');

        loadSavedItems(savedCoreListData);

        filterItems(coreListData);

        ko.bindingHandlers.colWidthCalculate = {
            update: function(element, valueAccessor, allBindings, viewModel, bindingContext) 
            {
                var data = ko.utils.unwrapObservable(valueAccessor());

                $('#itemPickerTableBody tr:eq(0) td').each(function (i)
                {
                    var cellWidth = $(this).outerWidth();
                    $('#itemPickerTableHeader tr:eq(0) th:eq(' + i + ')').css('width', cellWidth);
                });

                $('#basketTableBody tr:eq(0) td').each(function (i) {
                    var cellWidth = $(this).outerWidth();
                    $('#basketTableHeader tr:eq(0) th:eq(' + i + ')').css('width', cellWidth);
                });
            }
        };

        model.selectedTrade.subscribe(function (newValue)
        {
            filterItems(coreListData, newValue);
        });

        model.selectedSubCategory.subscribe(function (newValue) {
            filterItems(coreListData, model.selectedTrade(), newValue);            
        });

        model.selectedType.subscribe(function (newValue)
        {
            filterItems(coreListData, model.selectedTrade(), model.selectedSubCategory(), newValue);            
        });

        ko.applyBindings(model);
    });
</script>