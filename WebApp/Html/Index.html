<?!=HtmlService.createHtmlOutputFromFile('Stylesheet').getContent();?>

<!DOCTYPE html>
<html>
<head>

</head>
<body>

    <?!=HtmlService.createTemplateFromFile('Header').evaluate().getContent();?>

    <div class="container main-content">
        <div class="row">
            <?if(typeof data.kingdomHallAddress != 'undefined'){?>

            <div class="col-xs-4">
                <h3>Kingdom Hall Address:</h3>
            </div>
            <div class="col-xs-8">
                <h3>
                    <?=data.projectData.kingdomHallAddress?>

                </h3>
            </div>
            <?}?>

            <div class="col-xs-12">
                <div class="row">
                    <h3 class="col-xs-2">Core List</h3>
                    <div class="col-xs-10 form-inline" data-bind="visible: trades().length != 0">
                        <div class="form-group">
                            <label for="trades">Trade:</label>
                            <select class="form-control" data-bind="options: trades, value: selectedTrade, optionsCaption: 'Please Select...'"></select>
                        </div>
                        <div class="form-group" data-bind="visible: subCategories().length != 0">
                            <label for="trades">Category:</label>
                            <select class="form-control" data-bind="options: subCategories, value: selectedSubCategory, optionsCaption: 'Please Select...'"></select>
                        </div>
                        <div class="form-group" data-bind="visible: types().length != 0">
                            <label for="trades">Type:</label>
                            <select class="form-control" data-bind="options: types, value: selectedType, optionsCaption: 'Please Select...'"></select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="long-list-wrapper">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        Item Code
                                    </th>
                                    <th>
                                        Item Description
                                    </th>
                                    <th>
                                        Manufacturer
                                    </th>
                                    <th>
                                        Brand
                                    </th>
                                    <th>
                                        Part Number
                                    </th>
                                    <th>
                                        Project Dimension
                                    </th>
                                    <th>
                                        Quantity Required
                                    </th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody data-bind="if: typeof items == 'undefined' || items == null || items().length == 0">
                                <tr class="info">
                                    <td colspan="8">
                                        No Core List items have been loaded yet.
                                    </td>
                                </tr>
                            </tbody>
                            <tbody data-bind="foreach: items">
                                <tr>
                                    <td data-bind="text: itemCode"></td>
                                    <td data-bind="text: itemDescription"></td>
                                    <td data-bind="text: manufacturer"></td>
                                    <td data-bind="text: brand"></td>
                                    <td data-bind="text: partNumber"></td>
                                    <td>
                                        <select class="form-control" data-bind="options: pdcs, optionsText: function(item){ return item.code + ' ('  + item.description + ')'}, "></select>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control input-sm pull-right" style="width: 45px;" />
                                    </td>
                                    <td data-bind="text: purchaseUom + ' @ ' + factor + baseUom"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <h3>Saved Project Items</h3>
                    </div>
                </div>
                <div class="row">
                    <div class="long-list-wrapper">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        Item Code
                                    </th>
                                    <th>
                                        Item Description
                                    </th>
                                    <th>
                                        Manufacturer
                                    </th>
                                    <th>
                                        Brand
                                    </th>
                                    <th>
                                        Part Number
                                    </th>
                                    <th>
                                        Project Dimension
                                    </th>
                                    <th>
                                        Quantity Required
                                    </th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody data-bind="if: typeof savedItems == 'undefined' || savedItems == null || savedItems().length == 0">
                                <tr class="info">
                                    <td colspan="8">
                                        No Core List items have been saved yet.
                                    </td>
                                </tr>
                            </tbody>
                            <tbody data-bind="foreach: savedItems">
                                <tr>
                                    <td data-bind="text: itemCode"></td>
                                    <td data-bind="text: itemDescription"></td>
                                    <td data-bind="text: manufacturer"></td>
                                    <td data-bind="text: brand"></td>
                                    <td data-bind="text: partNumber"></td>
                                    <td data-bind="text: pdc"></td>
                                    <td data-bind="text: quantity"></td>
                                    <td data-bind="text: purchaseUom + ' @ ' + factor + baseUom"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<?!=HtmlService.createHtmlOutputFromFile('JavaScript').getContent();?>

<script language="javascript" type="text/javascript">
    var model;

    function loadData(data) {
        if (typeof data.filteredListData != 'undefined') {
            model.items(data.filteredListData);
        }

        if (typeof data.subCategories !== 'undefined') {
            model.subCategories(data.subCategories);
        }

        if (typeof data.types !== 'undefined') {
            model.types(data.types);
        }

        if (typeof data.projectDimensions !== 'undefined') {
            model.projectDimensions(data.projectDimensions);
        }

        toastr.clear();
    }

    function loadSavedItems(savedItems) {
        for (var i = 0; i < model.allItems().length; i++) {
            var itemsSaved = $.grep(savedItems, function (el) {
                return el.itemCode === model.allItems()[i].itemCode;
            });

            if (itemsSaved.length > 0) {
                var savedItem = model.allItems()[i];
                savedItem.quantity = itemsSaved[0].quantity;
                savedItem.pdc = itemsSaved[0].pdc;
                model.savedItems.push(savedItem);
            }
        }

        toastr.clear();
    }

    function showLoading() {
        toastr.warning('Please wait while Core List items load', 'Loading...', { timeOut: 0, tapToDismiss: false, positionClass: 'toast-top-full-width' });
    }

    function showLoadingSaved() {
        toastr.warning('Please wait while your saved Core List items load', 'Loading...', { timeOut: 0, tapToDismiss: false, positionClass: 'toast-top-full-width' });
    }

    $(function () {
        model = {
            items: ko.observableArray([]),
            allItems: ko.observableArray([]),
            selectedItems: ko.observableArray([]),
            trades: ko.observableArray([]),
            subCategories: ko.observableArray([]),
            types: ko.observableArray([]),
            projectDimensions: ko.observableArray([]),
            selectedTrade: ko.observable(''),
            selectedSubCategory: ko.observable(''),
            selectedType: ko.observable(''),
            selectedProjectDimension: ko.observable(),
            savedItems: ko.observableArray([])
        };

        var trades = JSON.parse('<?=data.trades?>');

        model.trades(trades);

        var coreListData = JSON.parse('<?=data.coreListData?>');

        model.allItems(coreListData);

        var savedCoreListData = JSON.parse('<?=data.savedCoreListData?>');

        loadSavedItems(savedCoreListData);


        model.selectedTrade.subscribe(function (newValue) {
            if (typeof newValue !== "undefined" && newValue !== '') {
                var filter = {
                    trade: newValue
                };

                showLoading();

                google.script.run.withSuccessHandler(loadData).getCoreListData(filter);
            }
        });

        model.selectedSubCategory.subscribe(function (newValue) {
            if (typeof newValue !== 'undefined' && newValue !== '') {
                var filter = {
                    trade: model.selectedTrade(),
                    category: newValue
                };

                showLoading();

                google.script.run.withSuccessHandler(loadData).getCoreListData(filter);
            }
        });

        model.selectedType.subscribe(function (newValue) {
            if (typeof newValue !== 'undefined' && newValue !== '') {
                var filter = {
                    trade: model.selectedTrade(),
                    category: model.selectedSubCategory(),
                    type: newValue
                };

                showLoading();

                google.script.run.withSuccessHandler(loadData).getCoreListData(filter);
            }
        });

        ko.applyBindings(model);
    });
</script>